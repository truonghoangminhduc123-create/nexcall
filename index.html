<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>NexCall Ultra - Perfect Fit</title>
    <!-- Quan tr·ªçng: Ch·ªëng zoom v√† tr√†n m√†n h√¨nh tr√™n ƒëi·ªán tho·∫°i -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #020617;
            --primary: #38bdf8;
            --glass: rgba(15, 23, 42, 0.9);
            --border: rgba(255, 255, 255, 0.1);
            --text: #f8fafc;
            --red: #ef4444;
            --green: #10b981;
        }

        /* Ch·ªëng cu·ªôn to√†n trang ƒë·ªÉ kh√¥ng b·ªã m·∫•t focus khi v·∫Ω */
        html, body {
            margin: 0; padding: 0; 
            width: 100%; height: 100%; 
            overflow: hidden; 
            position: fixed; /* Kh√≥a c·ª©ng v·ªã tr√≠ tr√™n mobile */
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg); color: var(--text);
        }

        /* Home Screen */
        .page-home { 
            height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px; 
            background: radial-gradient(circle at top right, #1e293b, #020617);
        }
        .card {
            width: 100%; max-width: 360px; background: var(--glass); backdrop-filter: blur(10px);
            border: 1px solid var(--border); border-radius: 24px; padding: 30px; text-align: center;
        }

        /* Room Screen - Layout 3 ph·∫ßn: Top (60px), Middle (Flex-1), Bottom (80px) */
        .page-room { display: none; height: 100vh; flex-direction: column; }
        
        .nav { 
            height: 60px; min-height: 60px; display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; border-bottom: 1px solid var(--border); background: var(--bg);
        }
        
        .tab-bar { display: flex; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 12px; }
        .tab-btn {
            border: none; background: transparent; color: #64748b; padding: 8px 10px;
            border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 700;
            display: flex; align-items: center; gap: 5px;
        }
        .tab-btn.active { background: rgba(56, 189, 248, 0.15); color: var(--primary); }

        .content { flex: 1; position: relative; width: 100%; overflow: hidden; }
        .view { position: absolute; inset: 0; display: none; flex-direction: column; padding: 10px; }
        .view.active { display: flex; }

        /* Board - T·ª± ƒë·ªông co gi√£n theo View */
        .canvas-container { 
            flex: 1; background: #fff; border-radius: 16px; position: relative; 
            overflow: hidden; touch-action: none; /* Quan tr·ªçng ƒë·ªÉ v·∫Ω tr√™n mobile */
        }
        canvas { display: block; width: 100%; height: 100%; }

        .controls { 
            height: 80px; min-height: 80px; display: flex; align-items: center; 
            justify-content: center; gap: 12px; border-top: 1px solid var(--border);
        }

        /* Cursor & UI Elements */
        .cursor { position: absolute; pointer-events: none; z-index: 10; opacity: 0; display: flex; flex-direction: column; align-items: center; }
        .cursor-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--primary); border: 2px solid #fff; }
        .cursor-name { background: var(--primary); color: #000; font-size: 9px; font-weight: 800; padding: 1px 4px; border-radius: 3px; margin-top: 2px; }

        input {
            width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--border);
            padding: 12px; border-radius: 12px; color: #fff; outline: none; font-size: 14px;
        }
        .btn { padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; width: 100%; }
        .btn-main { background: var(--primary); color: #000; }
        .btn-icon { width: 44px; height: 44px; border-radius: 12px; background: var(--glass); color: #fff; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; }

        #chat-list { flex: 1; overflow-y: auto; padding-bottom: 10px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 85%; padding: 8px 12px; border-radius: 14px; font-size: 13px; background: rgba(255,255,255,0.05); }
        .msg.me { align-self: flex-end; background: var(--primary); color: #000; }

        #toasts { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); z-index: 1000; width: 80%; pointer-events: none; }
        .toast { background: var(--glass); padding: 8px 16px; border-radius: 20px; text-align: center; margin-bottom: 5px; font-size: 12px; border: 1px solid var(--border); }
    </style>
</head>
<body>

<div id="toasts"></div>

<div class="page-home" id="home">
    <div class="card">
        <h2 style="margin:0 0 10px; color:var(--primary)">NexCall Ultra</h2>
        <p style="font-size:12px; color:#64748b; margin-bottom:25px">K·∫øt n·ªëi & V·∫Ω th·ªùi gian th·ª±c</p>
        <button class="btn btn-main" onclick="start(true)">T·∫†O PH√íNG M·ªöI</button>
        <div style="margin:15px 0; font-size:10px; font-weight:800; color:#475569">HO·∫∂C</div>
        <input id="roomId" placeholder="Nh·∫≠p m√£ ph√≤ng...">
        <button class="btn" style="background:rgba(255,255,255,0.05); color:#fff" onclick="start(false)">THAM GIA</button>
    </div>
</div>

<div class="page-room" id="room">
    <div class="nav">
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('board', this)"><i data-lucide="palette" size="16"></i> V·∫Ω</button>
            <button class="tab-btn" onclick="switchTab('chat', this)"><i data-lucide="message-square" size="16"></i> Chat</button>
            <button class="tab-btn" onclick="switchTab('users', this)"><i data-lucide="users" size="16"></i> <span id="user-count">1</span></button>
        </div>
        <button class="btn-icon" style="background:var(--red); border:none; width:36px; height:36px" onclick="location.reload()"><i data-lucide="power" size="16"></i></button>
    </div>

    <div class="content">
        <div class="view active" id="view-board">
            <div class="canvas-container" id="canvas-wrap">
                <canvas id="main-canvas"></canvas>
                <div id="cursors"></div>
            </div>
            <div class="controls">
                <button id="micBtn" class="btn-icon" style="background:var(--green); border:none;" onclick="toggleMic()"><i data-lucide="mic"></i></button>
                <button class="btn-icon" onclick="clearBoard()"><i data-lucide="eraser"></i></button>
                <button class="btn-icon" style="font-size:18px" onclick="sendMsg('üëç')">üëç</button>
                <button class="btn-icon" style="font-size:18px" onclick="sendMsg('üî•')">üî•</button>
            </div>
        </div>

        <div class="view" id="view-chat">
            <div id="chat-list"></div>
            <div style="display:flex; gap:8px">
                <input id="chatInput" placeholder="Tin nh·∫Øn..." style="margin:0" onkeypress="if(event.key==='Enter') sendMsg()">
                <button class="btn btn-main" style="width:50px" onclick="sendMsg()"><i data-lucide="send" size="18"></i></button>
            </div>
        </div>

        <div class="view" id="view-users">
            <p style="font-size:12px; color:#64748b; margin:0 0 5px">M√É PH√íNG:</p>
            <div style="font-size:24px; font-weight:800; color:var(--primary); margin-bottom:20px" id="display-id">---</div>
            <div id="user-list"></div>
        </div>
    </div>
</div>

<script>
    let peer, localStream, conns = {};
    let isMuted = false, drawing = false, lastX = 0, lastY = 0;
    const canvas = document.getElementById('main-canvas'), ctx = canvas.getContext('2d');

    lucide.createIcons();

    function shortName(id) { return id ? id.slice(-4) : "User"; }

    function resize() {
        const wrap = document.getElementById('canvas-wrap');
        if (!wrap) return;
        // T√≠nh to√°n k√≠ch th∆∞·ªõc th·∫≠t c·ªßa container
        canvas.width = wrap.clientWidth;
        canvas.height = wrap.clientHeight;
        ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineWidth = 3; ctx.strokeStyle = '#0f172a';
    }

    // L·∫Øng nghe c·∫£ s·ª± ki·ªán resize v√† xoay m√†n h√¨nh
    window.addEventListener('resize', resize);
    window.addEventListener('orientationchange', () => setTimeout(resize, 200));

    function toast(txt) {
        const container = document.getElementById('toasts');
        const el = document.createElement('div');
        el.className = 'toast'; el.innerText = txt;
        container.appendChild(el);
        setTimeout(() => { el.style.opacity = '0'; setTimeout(()=>el.remove(), 300); }, 2500);
    }

    async function start(isHost) {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const customId = isHost ? 'NEX-' + Math.random().toString(36).substring(2,8).toUpperCase() : null;
            peer = new Peer(customId);
            
            peer.on('open', id => {
                document.getElementById('home').style.display = 'none';
                document.getElementById('room').style.display = 'flex';
                document.getElementById('display-id').innerText = id;
                setTimeout(resize, 100);
                updateUsers();
                if(!isHost) {
                    const tid = document.getElementById('roomId').value.trim();
                    if(tid) connect(tid);
                }
            });

            peer.on('call', call => {
                call.answer(localStream);
                call.on('stream', s => { const a = new Audio(); a.srcObject = s; a.play(); });
            });
            peer.on('connection', c => handleConn(c));
        } catch(e) { alert("Vui l√≤ng cho ph√©p d√πng Micro!"); }
    }

    function connect(id) {
        peer.call(id, localStream).on('stream', s => { const a = new Audio(); a.srcObject = s; a.play(); });
        handleConn(peer.connect(id));
    }

    function handleConn(c) {
        conns[c.peer] = c;
        c.on('open', () => { toast("B·∫°n " + shortName(c.peer) + " ƒë√£ v√†o"); updateUsers(); });
        c.on('data', data => {
            if(data.t === 'draw') {
                ctx.beginPath(); ctx.moveTo(data.lx * canvas.width, data.ly * canvas.height);
                ctx.lineTo(data.x * canvas.width, data.y * canvas.height); ctx.stroke();
            }
            if(data.t === 'cursor') moveCursor(c.peer, data.x, data.y);
            if(data.t === 'chat') addChat(shortName(c.peer), data.v);
            if(data.t === 'clear') ctx.clearRect(0,0,canvas.width,canvas.height);
        });
        c.on('close', () => {
            toast("B·∫°n " + shortName(c.peer) + " ƒë√£ tho√°t");
            if(document.getElementById('cur-'+c.peer)) document.getElementById('cur-'+c.peer).remove();
            delete conns[c.peer];
            updateUsers();
        });
    }

    function moveCursor(id, xp, yp) {
        let el = document.getElementById('cur-' + id);
        if(!el) {
            el = document.createElement('div'); el.id = 'cur-' + id; el.className = 'cursor';
            el.innerHTML = `<div class="cursor-dot"></div><div class="cursor-name">${shortName(id)}</div>`;
            document.getElementById('cursors').appendChild(el);
        }
        el.style.left = (xp * canvas.width) + 'px';
        el.style.top = (yp * canvas.height) + 'px';
        el.style.opacity = '1';
        clearTimeout(el.timer); el.timer = setTimeout(() => el.style.opacity = '0', 2000);
    }

    // X·ª≠ l√Ω v·∫Ω ƒëa n·ªÅn t·∫£ng (Chu·ªôt + C·∫£m ·ª©ng)
    function handleDraw(e) {
        const r = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const x = (clientX - r.left) / r.width;
        const y = (clientY - r.top) / r.height;

        Object.values(conns).forEach(c => c.open && c.send({t:'cursor', x, y}));

        if (drawing) {
            ctx.beginPath(); ctx.moveTo(lastX * canvas.width, lastY * canvas.height); ctx.lineTo(x * canvas.width, y * canvas.height); ctx.stroke();
            Object.values(conns).forEach(c => c.open && c.send({t:'draw', x, y, lx:lastX, ly:lastY}));
            lastX = x; lastY = y;
        }
    }

    canvas.addEventListener('pointerdown', e => { 
        drawing = true; 
        const r = canvas.getBoundingClientRect();
        lastX = (e.clientX - r.left) / r.width; 
        lastY = (e.clientY - r.top) / r.height; 
    });
    canvas.addEventListener('pointermove', handleDraw);
    window.addEventListener('pointerup', () => drawing = false);

    function switchTab(id, btn) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('view-' + id).classList.add('active');
        btn.classList.add('active');
        if(id === 'board') setTimeout(resize, 50);
    }

    function sendMsg(val) {
        const input = document.getElementById('chatInput');
        const txt = val || input.value;
        if(!txt) return;
        Object.values(conns).forEach(c => c.open && c.send({t:'chat', v:txt}));
        addChat("T√¥i", txt, true);
        input.value = "";
    }

    function addChat(user, txt, isMe) {
        const list = document.getElementById('chat-list');
        const el = document.createElement('div');
        el.className = `msg ${isMe?'me':''}`;
        el.innerHTML = `<strong>${user}:</strong> ${txt}`;
        list.appendChild(el);
        list.scrollTop = list.scrollHeight;
    }

    function updateUsers() {
        const list = document.getElementById('user-list');
        document.getElementById('user-count').innerText = Object.keys(conns).length + 1;
        list.innerHTML = `<div class="user-row"><span>T√¥i (${shortName(peer.id)})</span><div style="width:8px;height:8px;background:var(--green);border-radius:50%"></div></div>`;
        Object.keys(conns).forEach(id => {
            list.innerHTML += `<div class="user-row"><span>Partner (${shortName(id)})</span><div style="width:8px;height:8px;background:var(--primary);border-radius:50%"></div></div>`;
        });
    }

    function toggleMic() {
        isMuted = !isMuted;
        localStream.getAudioTracks()[0].enabled = !isMuted;
        const btn = document.getElementById('micBtn');
        btn.style.background = isMuted ? 'var(--red)' : 'var(--green)';
        btn.innerHTML = `<i data-lucide="${isMuted?'mic-off':'mic'}" size="20"></i>`;
        lucide.createIcons();
    }

    function clearBoard() { ctx.clearRect(0,0,canvas.width,canvas.height); Object.values(conns).forEach(c => c.open && c.send({t:'clear'})); }
</script>
</body>
</html>

